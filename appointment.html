<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>醫師團隊與預約掛號</title>
  <style>
    /* 省略前面重複的 CSS，請同 dashboard.html 取用共用樣式 */
    body { font-family:"Segoe UI","Microsoft JhengHei",sans-serif; background-color:#f7f9fa; margin:20px; }
    .container { max-width:1200px; margin:auto; padding:40px 20px; }
    .title{ text-align:center;color:#2c3e50;margin-bottom:40px;}
    .department{margin-bottom:60px;}
    .department h2{font-size:24px;color:#1f3a93;border-left:5px solid #1f3a93;padding-left:10px;margin-bottom:20px;}
    .doctor-list{display:flex;flex-wrap:wrap;gap:20px;}
    .card{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);width:230px;overflow:hidden;}
    .card img{width:100%;max-height:150px;object-fit:contain;background:#f0f0f0;}
    .card-content{padding:10px;}
    .card h3{margin:0 0 3px;font-size:15px;color:#333;}
    .card p{margin:3px 0;font-size:12px;color:#555;line-height:1.4;}
    .form-container{max-width:600px;background:#fff;margin:40px auto;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .form-container h2{text-align:center;color:#333;margin-bottom:30px;}
    label{display:block;margin-top:18px;margin-bottom:6px;font-weight:bold;color:#444;}
    select,input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9;font-size:16px;}
    select:focus,input:focus{border-color:#3399ff;background:#fff;outline:none;}
    button{width:100%;padding:14px;margin-top:30px;background:#3399ff;color:#fff;border:none;border-radius:8px;font-size:18px;cursor:pointer;}
    button:hover{background:#007acc;}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">醫師團隊介紹</h1>
    <div id="department-container"></div>
  </div>

  <div class="form-container">
    <h2>病人預約掛號系統</h2>
    <form id="booking_form">
      <label for="dept_id">選擇科別：</label>
      <select id="dept_id" name="department_id" required>
        <option value="">請選擇科別</option>
      </select>

      <label for="date">選擇日期：</label>
      <input type="date" id="date" name="date" required />

      <label for="service_type">選擇時段：</label>
      <select id="service_type" name="service_type" required>
        <option value="morning">上午</option>
        <option value="afternoon">下午</option>
        <option value="evening">晚上</option>
      </select>

      <label for="doctor_id">選擇醫生：</label>
      <select id="doctor_id" name="doctor_id" required>
        <option value="">請先選擇科別、日期與時段</option>
      </select>

      <label for="patient_id">病人帳號：</label>
      <input type="text" id="patient_id" name="patient_id" readonly />

      <button type="submit">送出預約</button>
    </form>
  </div>

  <script>
    // 取 token + patient_id
    const token = localStorage.getItem('token');
    const patientId = localStorage.getItem('patient_id');
    if (!token)  location.href = 'portal.html';
    document.getElementById('patient_id').value = patientId || '';

    // 1. 載入部門列表
    async function loadDepartments() {
      const res = await fetch('/api/v1/departments');
      const data = await res.json();
      if (!data.error) {
        const sel = document.getElementById('dept_id');
        data.departments.forEach(d => {
          const opt = new Option(d.dept_name, d.dept_id);
          sel.add(opt);
        });
      }
    }

    // 2. 根據 dept/date/時段 動態載入醫師
    async function loadDoctors() {
      const deptId = document.getElementById('dept_id').value;
      const date   = document.getElementById('date').value;
      const slot   = document.getElementById('service_type').value;
      if (!deptId || !date || !slot) return;

      // 先拿該科所有醫師
      const res1 = await fetch(`/api/v1/departments/${deptId}/doctors`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const d1   = await res1.json();
      if (d1.error) return alert(d1.message);

      const sel = document.getElementById('doctor_id');
      sel.innerHTML = '';
      d1.doctors.forEach(async doc => {
        // 再查該醫師當日可約時段
        const res2 = await fetch(`/api/v1/doctors/${doc.doctor_id}/available?date=${date}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const d2 = await res2.json();
        if (!d2.error && d2.available_slots.length>0) {
          const opt = new Option(doc.doctor_name, doc.doctor_id);
          sel.add(opt);
        }
      });
    }

    // 3. 送出預約
    document.getElementById('booking_form').addEventListener('submit', async e => {
      e.preventDefault();
      const deptId  = +document.getElementById('dept_id').value;
      const doctorId= +document.getElementById('doctor_id').value;
      const date    = document.getElementById('date').value;
      const slot    = document.getElementById('service_type').value;
      // 建成 ISO 字串（示範取當天 09:00）
      const timeMap = { morning:'09:00:00Z', afternoon:'14:00:00Z', evening:'19:00:00Z' };
      const apptTime= new Date(date+'T'+timeMap[slot]).toISOString();

      const payload = {
        department_id:    deptId,
        doctor_id:        doctorId,
        patient_id:       patientId,
        appointment_time: apptTime,
        service_type:     slot
      };

      const res = await fetch('/api/v1/appointments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization':  'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });
      const d = await res.json();
      if (d.error) {
        return alert('預約失敗：' + d.message);
      }
      alert('預約成功！預約編號：' + d.appointment.appointment_id);
      // 可以再跳轉或清空表單
    });

    // init
    document.getElementById('dept_id').addEventListener('change', loadDoctors);
    document.getElementById('date').addEventListener('change', loadDoctors);
    document.getElementById('service_type').addEventListener('change', loadDoctors);
    loadDepartments();
  </script>
</body>
</html>
